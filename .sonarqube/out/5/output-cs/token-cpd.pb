üp
bD:\GIT_EFITEC2021\GrupoFeFaseDos\HumanManagement\HumanManagement.Mail\Repository\MailRepository.cs
	namespace 	
HumanManagement
 
. 
Mail 
. 

Repository )
{ 
public 

class 
MailRepository 
:  
IMailRepository! 0
{ 
public 
IConfiguration 
Configuration +
{, -
get. 1
;1 2
}3 4
private 
string 
	m_exePath  
=! "
string# )
.) *
Empty* /
;/ 0
public 
MailRepository 
( 
IConfiguration ,
configuration- :
): ;
{ 	
Configuration 
= 
configuration )
;) *
} 	
public 
async 
Task 
< 
bool 
> 
SendMail  (
(( )
MailRequestDto) 7
mailRequest8 C
)C D
{ 	
var!! 
email!! 
=!! 
new!! 
MimeMessage!! '
(!!' (
)!!( )
;!!) *
email$$ 
.$$ 
From$$ 
.$$ 
Add$$ 
($$ 
new$$ 
MailboxAddress$$ -
($$- .
Configuration$$. ;
[$$; <
$str$$< ^
]$$^ _
.$$_ `
ToString$$` h
($$h i
)$$i j
,$$j k
Configuration$$l y
[$$y z
$str	$$z ú
]
$$ú ù
.
$$ù û
ToString
$$û ¶
(
$$¶ ß
)
$$ß ®
)
$$® ©
)
$$© ™
;
$$™ ´
foreach&& 
(&& 
var&& 
semail&& 
in&&  "
mailRequest&&# .
.&&. /
To&&/ 1
)&&1 2
{'' 
email(( 
.(( 
To(( 
.(( 
Add(( 
((( 
MailboxAddress(( +
.((+ ,
Parse((, 1
(((1 2
semail((2 8
)((8 9
)((9 :
;((: ;
})) 
if** 
(** 
mailRequest** 
.** 
Cc** 
!=** !
null**" &
)**& '
{++ 
foreach,, 
(,, 
var,, 
semail,, #
in,,$ &
mailRequest,,' 2
.,,2 3
Cc,,3 5
),,5 6
{-- 
email.. 
... 
Cc.. 
... 
Add..  
(..  !
MailboxAddress..! /
.../ 0
Parse..0 5
(..5 6
semail..6 <
)..< =
)..= >
;..> ?
}// 
}00 
if11 
(11 
mailRequest11 
.11 
Bcc11 
!=11  "
null11# '
)11' (
{22 
foreach33 
(33 
var33 
semail33 #
in33$ &
mailRequest33' 2
.332 3
Bcc333 6
)336 7
{44 
email55 
.55 
Bcc55 
.55 
Add55 !
(55! "
MailboxAddress55" 0
.550 1
Parse551 6
(556 7
semail557 =
)55= >
)55> ?
;55? @
}66 
}77 
email88 
.88 
Subject88 
=88 
mailRequest88 '
.88' (
Message88( /
.88/ 0
Subject880 7
;887 8
var;; 
builder;; 
=;; 
new;; 
BodyBuilder;; )
(;;) *
);;* +
;;;+ ,
if== 
(== 
mailRequest== 
.== 
Message== #
.==# $
Body==$ (
.==( )
Format==) /
====0 2
EnumBodyMail==4 @
.==@ A
Flowed==A G
)==G H
{>> 
builder?? 
.?? 
TextBody??  
=??! "
mailRequest??# .
.??. /
Message??/ 6
.??6 7
Body??7 ;
.??; <
Value??< A
;??A B
}@@ 
ifAA 
(AA 
mailRequestAA 
.AA 
MessageAA #
.AA# $
BodyAA$ (
.AA( )
FormatAA) /
==AA0 2
EnumBodyMailAA4 @
.AA@ A
HtmlAAA E
)AAE F
{BB 
builderCC 
.CC 
HtmlBodyCC  
=CC! "
mailRequestCC# .
.CC. /
MessageCC/ 6
.CC6 7
BodyCC7 ;
.CC; <
ValueCC< A
;CCA B
}DD 
ListEE 
<EE 
stringEE 
>EE 
strPathFilesEE %
=EE& '
newEE( +
ListEE, 0
<EE0 1
stringEE1 7
>EE7 8
(EE8 9
)EE9 :
;EE: ;
ifFF 
(FF 
mailRequestFF 
.FF 
MessageFF #
.FF# $

AttachmentFF$ .
!=FF/ 1
nullFF2 6
)FF6 7
{GG 
stringII 
newPathII 
=II  
ConfigurationII! .
[II. /
$strII/ N
]IIN O
.IIO P
ToStringIIP X
(IIX Y
)IIY Z
;IIZ [
ifJJ 
(JJ 
!JJ 
	DirectoryJJ 
.JJ 
ExistsJJ %
(JJ% &
newPathJJ& -
)JJ- .
)JJ. /
{KK 
	DirectoryLL 
.LL 
CreateDirectoryLL -
(LL- .
newPathLL. 5
)LL5 6
;LL6 7
}MM 
foreachNN 
(NN 
varNN 
file64bNN $
inNN% '
mailRequestNN( 3
.NN3 4
MessageNN4 ;
.NN; <

AttachmentNN< F
)NNF G
{OO 
BytePP 
[PP 
]PP 
bytesPP  
=PP! "
ConvertPP# *
.PP* +
FromBase64StringPP+ ;
(PP; <
file64bPP< C
.PPC D
ValuePPD I
)PPI J
;PPJ K
stringQQ 
pathfileQQ #
=QQ$ %
newPathQQ& -
+QQ. /
file64bQQ0 7
.QQ7 8
FileNameQQ8 @
;QQ@ A
FileSS 
.SS 
WriteAllBytesSS &
(SS& '
pathfileSS' /
,SS/ 0
bytesSS1 6
)SS6 7
;SS7 8
builderTT 
.TT 
AttachmentsTT '
.TT' (
AddTT( +
(TT+ ,
pathfileTT, 4
)TT4 5
;TT5 6
strPathFilesUU  
.UU  !
AddUU! $
(UU$ %
pathfileUU% -
)UU- .
;UU. /
}VV 
}WW 
emailYY 
.YY 
BodyYY 
=YY 
builderYY  
.YY  !
ToMessageBodyYY! .
(YY. /
)YY/ 0
;YY0 1
tryZZ 
{[[ 
LogWrite^^ 
(^^ 
$str^^ 0
)^^0 1
;^^1 2
using__ 
var__ 
smtp__ 
=__  
new__! $

SmtpClient__% /
(__/ 0
)__0 1
;__1 2
LogWritebb 
(bb 
$strbb C
)bbC D
;bbD E
smtpcc 
.cc &
CheckCertificateRevocationcc /
=cc0 1
falsecc2 7
;cc7 8
LogWritedd 
(dd 
$strdd 6
)dd6 7
;dd7 8
smtpee 
.ee /
#ServerCertificateValidationCallbackee 8
=ee9 :
(ee; <
see< =
,ee= >
cee? @
,ee@ A
cheeB D
,eeD E
eeeF G
)eeG H
=>eeI K
trueeeL P
;eeP Q
LogWriteff 
(ff 
$strff 2
)ff2 3
;ff3 4
LogWritegg 
(gg 
$strgg '
+gg( )
Configurationgg* 7
[gg7 8
$strgg8 P
]ggP Q
.ggQ R
ToStringggR Z
(ggZ [
)gg[ \
)gg\ ]
;gg] ^
LogWritehh 
(hh 
$strhh #
+hh$ %
inthh& )
.hh) *
Parsehh* /
(hh/ 0
Configurationhh0 =
[hh= >
$strhh> T
]hhT U
.hhU V
ToStringhhV ^
(hh^ _
)hh_ `
)hh` a
)hha b
;hhb c
smtpii 
.ii 
Connectii 
(ii 
Configurationii *
[ii* +
$strii+ C
]iiC D
.iiD E
ToStringiiE M
(iiM N
)iiN O
,iiO P
intiiQ T
.iiT U
ParseiiU Z
(iiZ [
Configurationii[ h
[iih i
$striii 
]	ii Ä
.
iiÄ Å
ToString
iiÅ â
(
iiâ ä
)
iiä ã
)
iiã å
,
iiå ç!
SecureSocketOptions
iié °
.
ii° ¢
StartTls
ii¢ ™
)
ii™ ´
;
ii´ ¨
LogWritell 
(ll 
$strll 1
+ll2 3
Configurationll4 A
[llA B
$strllB X
]llX Y
.llY Z
ToStringllZ b
(llb c
)llc d
)lld e
;lle f
smtpmm 
.mm 
Authenticatemm !
(mm! "
Configurationmm" /
[mm/ 0
$strmm0 F
]mmF G
.mmG H
ToStringmmH P
(mmP Q
)mmQ R
,mmR S
ConfigurationmmT a
[mma b
$strmmb |
]mm| }
.mm} ~
ToString	mm~ Ü
(
mmÜ á
)
mmá à
)
mmà â
;
mmâ ä
LogWritenn 
(nn 
$strnn 8
)nn8 9
;nn9 :
LogWriteoo 
(oo 
$stroo 0
)oo0 1
;oo1 2
smtppp 
.pp 
Sendpp 
(pp 
emailpp 
)pp  
;pp  !
LogWriteqq 
(qq 
$strqq 6
)qq6 7
;qq7 8
LogWriterr 
(rr 
$strrr +
)rr+ ,
;rr, -
smtpss 
.ss 

Disconnectss 
(ss  
truess  $
)ss$ %
;ss% &
LogWritett 
(tt 
$strtt $
)tt$ %
;tt% &
}uu 
catchvv 
(vv 
	Exceptionvv 
exvv 
)vv  
{ww 
foreachxx 
(xx 
varxx 
pathxx !
inxx" $
strPathFilesxx% 1
)xx1 2
{yy 
if{{ 
({{ 
System{{ 
.{{ 
IO{{ !
.{{! "
File{{" &
.{{& '
Exists{{' -
({{- .
path{{. 2
){{2 3
){{3 4
{|| 
System}} 
.}} 
IO}} !
.}}! "
File}}" &
.}}& '
Delete}}' -
(}}- .
path}}. 2
)}}2 3
;}}3 4
}~~ 
} 
LogWrite
ÄÄ 
(
ÄÄ 
$str
ÄÄ ,
)
ÄÄ, -
;
ÄÄ- .
LogWrite
ÅÅ 
(
ÅÅ 
ex
ÅÅ 
.
ÅÅ 
Message
ÅÅ #
)
ÅÅ# $
;
ÅÅ$ %
return
ÉÉ 
false
ÉÉ 
;
ÉÉ 
}
ÑÑ 
foreach
ÜÜ 
(
ÜÜ 
var
ÜÜ 
path
ÜÜ 
in
ÜÜ  
strPathFiles
ÜÜ! -
)
ÜÜ- .
{
áá 
if
ââ 
(
ââ 
System
ââ 
.
ââ 
IO
ââ 
.
ââ 
File
ââ "
.
ââ" #
Exists
ââ# )
(
ââ) *
path
ââ* .
)
ââ. /
)
ââ/ 0
{
ää 
System
ãã 
.
ãã 
IO
ãã 
.
ãã 
File
ãã "
.
ãã" #
Delete
ãã# )
(
ãã) *
path
ãã* .
)
ãã. /
;
ãã/ 0
}
åå 
}
çç 
LogWrite
íí 
(
íí 
$str
íí $
)
íí$ %
;
íí% &
return
ïï 
true
ïï 
;
ïï 
}
ññ 	
public
óó 
void
óó 
LogWrite
óó 
(
óó 
string
óó #

logMessage
óó$ .
)
óó. /
{
òò 	
	m_exePath
ôô 
=
ôô 
Configuration
ôô %
[
ôô% &
$str
ôô& @
]
ôô@ A
.
ôôA B
ToString
ôôB J
(
ôôJ K
)
ôôK L
;
ôôL M
try
öö 
{
õõ 
using
ùù 
(
ùù 
StreamWriter
ùù #
w
ùù$ %
=
ùù& '
File
ùù( ,
.
ùù, -

AppendText
ùù- 7
(
ùù7 8
	m_exePath
ùù8 A
+
ùùB C
$str
ùùD H
+
ùùI J
$str
ùùK T
)
ùùT U
)
ùùU V
{
ûû 
Log
üü 
(
üü 

logMessage
üü "
,
üü" #
w
üü$ %
)
üü% &
;
üü& '
}
†† 
}
°° 
catch
¢¢ 
(
¢¢ 
	Exception
¢¢ 
ex
¢¢ 
)
¢¢  
{
££ 
}
§§ 
}
•• 	
public
¶¶ 
void
¶¶ 
Log
¶¶ 
(
¶¶ 
string
¶¶ 

logMessage
¶¶ )
,
¶¶) *

TextWriter
¶¶+ 5
	txtWriter
¶¶6 ?
)
¶¶? @
{
ßß 	
try
®® 
{
©© 
	txtWriter
™™ 
.
™™ 
Write
™™ 
(
™™  
$str
™™  2
)
™™2 3
;
™™3 4
	txtWriter
´´ 
.
´´ 
	WriteLine
´´ #
(
´´# $
$str
´´$ 2
,
´´2 3
DateTime
´´4 <
.
´´< =
Now
´´= @
.
´´@ A
ToLongTimeString
´´A Q
(
´´Q R
)
´´R S
,
´´S T
DateTime
´´T \
.
´´\ ]
Now
´´] `
.
´´` a
ToLongDateString
´´a q
(
´´q r
)
´´r s
,
´´s t

logMessage
´´u 
)´´ Ä
;´´Ä Å
}
¨¨ 
catch
≠≠ 
(
≠≠ 
	Exception
≠≠ 
ex
≠≠ 
)
≠≠  
{
ÆÆ 
}
ØØ 
}
∞∞ 	
}
≤≤ 
}≥≥ 